<p>
 The following examples demonstrate some common practices for implementing a custom Option exercise model.
</p>
<h4>
 Example 1: Cash Settlement
</h4>
<p>
 The following algorithm trades GOOG 30-day expiring straddle. Yet, instead of settling with the underlying stock, some brokerages will settle with cash for ITM options. To simulate this behavior, we can create a custom option exercise model.
</p>
<div class="section-example-container testable">
 <pre class="csharp">using static QuantConnect.Extensions;
public class OptionExerciseModelAlgorithm : QCAlgorithm
{
    private Symbol _goog;

    public override void Initialize()
    {
        SetStartDate(2024, 9, 1);
        SetEndDate(2024, 12, 31);

        // Request GOOG option data for trading.
        var security = AddOption("GOOG");
        _goog = security.Symbol;
        // Filter for the 2 ATM contracts expiring in 30 days to form a straddle strategy.
        security.SetFilter((universe) =&gt; universe.Straddle(30));
        // Set custom option exercise model for disabling exercise through security initializer.
        Settings.SeedInitialPrices = true;
        AddSecurityInitializer(security =&gt;
        {
            // Set the custom Option exercise model for Option securities
            if (security.Type == SecurityType.Option)
            {
                (security as Option).SetOptionExerciseModel(new MyOptionExerciseModel());
            }
        });
    }

    public override void OnData(Slice slice)
    {
        // Open position on updated option chain data.
        if (!Portfolio.Invested &amp;&amp; slice.OptionChains.TryGetValue(_goog, out var chain))
        {
            // Only one strike and expiry for the straddle universe.
            var strike = chain.Min(x =&gt; x.Strike);
            var expiry = chain.Min(x =&gt; x.Expiry);
            // Open the straddle position.
            var optionStrategy = OptionStrategies.Straddle(_goog, strike, expiry);
            Buy(optionStrategy, 5);
        }
    }

    // Define the custom Option exercise model outside of the algorithm
    private class MyOptionExerciseModel : IOptionExerciseModel
    {
        public IEnumerable&lt;OrderEvent&gt; OptionExercise(Option option, OptionExerciseOrder order)
        {
            var underlying = option.Underlying;
            var utcTime = option.LocalTime.ConvertToUtc(option.Exchange.TimeZone);
            var inTheMoney = option.IsAutoExercised(underlying.Close);
            // Cash settle: using payoff.
            var payoff = option.GetIntrinsicValue(underlying.Close);

            // Only liquidate option positions, but do not add equity positions.
            yield return new OrderEvent(
                order.Id,
                option.Symbol,
                utcTime,
                OrderStatus.Filled,
                GetOrderDirection(order.Quantity),
                payoff,
                order.Quantity,
                OrderFee.Zero,
                "Option Settlement"
            )
            {
                IsInTheMoney = inTheMoney
            };
        }
    }
}</pre>
<pre class="python">class OptionExerciseModelAlgorithm(QCAlgorithm):
    def initialize(self) -&gt; None:
        self.set_start_date(2024, 9, 1)
        self.set_end_date(2024, 12, 31)

        # Request GOOG option data for trading.
        security = self.add_option("GOOG")
        self.goog = security.symbol
        # Filter for the 2 ATM contracts expiring in 30 days to form a straddle strategy.
        security.set_filter(lambda universe: universe.straddle(30))
        # Set custom option exercise model for disabling exercise through security initializer.
        self.settings.seed_initial_prices = True

    def on_data(self, slice: Slice) -&gt; None:
        # Open position on updated option chain data.
        chain = slice.option_chains.get(self.goog)
        if chain and not self.portfolio.invested:
            # Only one strike and expiry for the straddle universe.
            strike = min(x.strike for x in chain)
            expiry = min(x.expiry for x in chain)
            # Open the straddle position.
            option_straddle = OptionStrategies.straddle(self.goog, strike, expiry)
            self.buy(option_straddle, 5)

class MySecurityInitializer(BrokerageModelSecurityInitializer):
    def __init__(self, brokerageModel, securitySeeder):
        super().__init__(brokerageModel, securitySeeder)

    def initialize(self, security: Security) -&gt; None:
        super().initialize(security)

        # Set the custom Option exercise model for Option securities
        if security.type == SecurityType.OPTION:
            security.set_option_exercise_model(MyOptionExerciseModel())

# Define the custom Option exercise model outside of the algorithm
class MyOptionExerciseModel(DefaultExerciseModel):
    def option_exercise(self, option: Option, order: OptionExerciseOrder) -&gt; List[OrderEvent]:
        underlying = option.underlying
        utc_time = Extensions.convert_to_utc(option.local_time, option.exchange.time_zone)
        in_the_money = option.is_auto_exercised(underlying.close)
        # Cash settle: using payoff.
        payoff = option.get_intrinsic_value(underlying.close)

        # Only liquidate option positions, but do not add equity positions.
        order_event = OrderEvent(
            order.id,
            option.symbol,
            utc_time,
            OrderStatus.FILLED,
            Extensions.get_order_direction(order.quantity),
            payoff,
            order.quantity,
            OrderFee.ZERO,
            "Option Settlement"
        )
        order_event.is_in_the_money = in_the_money
        return [ order_event ]</pre>
</div>


<h4>
 Example 2: Default Model Implementation
</h4>
<p>
 The following algorithm implements the <code>DefaultExerciseModel</code> so you can easily customize the parts you need.
</p>

<div class="section-example-container testable">
 <pre class="csharp">public class CustomExerciseModelAlgorithm : QCAlgorithm
{
    private Symbol _optionSymbol;
    public override void Initialize()
    {
        SetStartDate(2024, 9, 1);
        SetEndDate(2024, 12, 31);
        SetCash(100000);
        Settings.SeedInitialPrices = true;
        AddSecurityInitializer(security =>
        {
            // Set the custom Option exercise model for Option securities
            if (security.Type == SecurityType.Option)
            {
                (security as Option).SetOptionExerciseModel(new MyOptionExerciseModel(this));
            }
        });
        var option = AddOption("SPY");
        _optionSymbol = option.Symbol;
    }

    /// OnData event is the primary entry point for your algorithm. Each new data point will be pumped in here.
    /// Slice object keyed by symbol containing the stock data
    public override void OnData(Slice data)
    {
        if (Portfolio.Invested)
        {
            return;
        }
        if (data.OptionChains.TryGetValue(_optionSymbol, out var chain))
        {
            var contract = chain
                .Where(x => x.Right == OptionRight.Call)
                .OrderBy(x => x.Strike)
                .FirstOrDefault();

            MarketOrder(contract.Symbol, 1);
            ExerciseOption(contract.Symbol, 1);
            Quit();
        }
    }
}

public class MyOptionExerciseModel : IOptionExerciseModel
{
    private readonly QCAlgorithm _algorithm;
    public MyOptionExerciseModel(QCAlgorithm algorithm) => _algorithm = algorithm;

    public IEnumerable&lt;OrderEvent&gt; OptionExercise(Option option, OptionExerciseOrder order)
    {
        var underlying = option.Underlying;
        var utcTime = option.LocalTime.ConvertToUtc(option.Exchange.TimeZone);

        var inTheMoney = option.IsAutoExercised(underlying.Close);
        var isAssignment = inTheMoney && option.Holdings.IsShort;

        yield return new OrderEvent(
            order.Id,
            option.Symbol,
            utcTime,
            OrderStatus.Filled,
            GetOrderDirection(order.Quantity),
            0.0m,
            order.Quantity,
            OrderFee.Zero,
            Messages.DefaultExerciseModel.ContractHoldingsAdjustmentFillTag(inTheMoney, isAssignment, option)
        )
        {
            IsAssignment = isAssignment,
            IsInTheMoney = inTheMoney
        };

        if (inTheMoney && option.ExerciseSettlement == SettlementType.PhysicalDelivery)
        {
            var exerciseQuantity = option.GetExerciseQuantity(order.Quantity);

            yield return new OrderEvent(
                order.Id,
                underlying.Symbol,
                utcTime,
                OrderStatus.Filled,
                GetOrderDirection(exerciseQuantity),
                option.StrikePrice,
                exerciseQuantity,
                OrderFee.Zero,
                isAssignment ? Messages.DefaultExerciseModel.OptionAssignment : Messages.DefaultExerciseModel.OptionExercise
            ) { IsInTheMoney = true };
        }
    }
}
</pre>
<pre class="python">class CustomExerciseModelAlgorithm(QCAlgorithm):

    def initialize(self):
        self.set_start_date(2024, 9, 1)
        self.set_end_date(2024, 12, 31)
        self.set_cash(100000)
        self.settings.seed_initial_prices = True
        self.add_security_initializer(self._custom_security_initializer)   
        option = self.add_option("SPY")
        self.option_symbol = option.symbol

    def on_data(self, data: Slice):
        if self.portfolio.invested:
            return
        chain = data.option_chains.get(self.option_symbol)
        if chain:
            contract = sorted([x for x in chain if x.right == OptionRight.CALL],
                key=lambda x: x.strike)[0]
            self.market_order(contract.symbol, 1)
            self.exercise_option(contract.symbol, 1)
            self.quit()

    def _custom_security_initializer(self, security: Security) -> None:
        if security.type == SecurityType.OPTION:
            security.set_option_exercise_model(MyOptionExerciseModel(self))


class MyOptionExerciseModel(DefaultExerciseModel):

    def __init__(self, algorithm):
        self.algorithm = algorithm

    def option_exercise(self, option: Option, order: OptionExerciseOrder) -> List[OrderEvent]:
        order_events = []

        underlying = option.underlying
        utc_time = Extensions.convert_to_utc(option.local_time, option.exchange.time_zone)

        in_the_money = option.is_auto_exercised(underlying.close)
        is_assignment = in_the_money and option.holdings.is_short
        messages = Messages.DefaultExerciseModel

        order_event = OrderEvent(
            order.id,
            option.symbol,
            utc_time,
            OrderStatus.FILLED,
            Extensions.get_order_direction(order.quantity),
            0,
            order.quantity,
            OrderFee.ZERO,
            messages.contract_holdings_adjustment_fill_tag(in_the_money, is_assignment, option)
        )
        order_event.is_assignment = is_assignment
        order_event.is_in_the_money = in_the_money
        order_events.append(order_event)

        if in_the_money and option.exercise_settlement == SettlementType.PHYSICAL_DELIVERY:
            exercise_quantity = option.get_exercise_quantity(order.quantity);
            order_event =  OrderEvent(
                order.id,
                underlying.symbol,
                utc_time,
                OrderStatus.FILLED,
                Extensions.get_order_direction(exercise_quantity),
                option.strike_price,
                exercise_quantity,
                OrderFee.ZERO,
                messages.option_assignment if is_assignment else messages.option_exercise
            )
            order_event.is_in_the_money = True
            order_events.append(order_event)

        return order_events</pre>
</div>


<h4>
 Other Examples
</h4>
<p>
 For more examples, see the following algorithms:
</p>
<div class="example-fieldset">
 <div class="example-legend">
  Demonstration Algorithms
 </div>
 <a class="python example-algorithm-link" href="https://github.com/QuantConnect/Lean/blob/master/Algorithm.Python/CustomOptionExerciseModelRegressionAlgorithm.py" target="_BLANK">
  CustomOptionExerciseModelRegressionAlgorithm.py
  <span class="badge-python pull-right">
   Python
  </span>
 </a>
 <a class="csharp example-algorithm-link" href="https://github.com/QuantConnect/Lean/blob/master/Algorithm.CSharp/CustomOptionExerciseModelRegressionAlgorithm.cs" target="_BLANK">
  CustomOptionExerciseModelRegressionAlgorithm.cs
  <span class="badge badge-sm badge-csharp pull-right">
   C#
  </span>
 </a>
</div>
