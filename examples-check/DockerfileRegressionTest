#
#   Regression Tests for Example Algorithms
#

# Start with the Ubuntu 20.04 base image
FROM ubuntu:20.04

# Set environment variables to avoid interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive

# Install necessary packages and PHP
RUN apt-get update
RUN apt-get install -y php python3 python3-venv python3-dev git
RUN apt-get clean
RUN rm -rf /var/lib/apt/lists/*

# Upgrade pip and install Python dependencies
RUN apt-get update && \
    apt-get install -y python3-pip
RUN pip install --upgrade pip
RUN pip install beautifulsoup4==4.12.3
RUN pip install ratelimit==2.2.1
RUN pip install requests==2.31.0

# Set the working directory to the Documentation directory
WORKDIR /app/Documentation

# Copy the necessary files into the container
COPY ../.. .

# Define and set the environmental variables of the regression tester
ARG VALIDATION_MODE
ARG QC_USER_ID
ARG QC_USER_TOKEN
ARG CS_PROJECT_ID
ARG PY_PROJECT_ID
ENV DOCS_REGRESSION_TEST_VALIDATION_MODE = $VALIDATION_MODE
ENV DOCS_REGRESSION_TEST_USER_ID = $QC_USER_ID
ENV DOCS_REGRESSION_TEST_USER_TOKEN = $QC_USER_TOKEN
ENV DOCS_REGRESSION_TEST_CS_PROJECT = $CS_PROJECT_ID
ENV DOCS_REGRESSION_TEST_PY_PROJECT = $PY_PROJECT_ID

# Run the regression tester
CMD ["python3", "examples-check/example-regression-algorithm-test.py"]

# Commit and push to GH branch
RUN if [[ $(git diff | wc -m) -eq 0 ]]; then \
        exit 0; \
    fi
RUN git config user.name GitHub Actions && \
    git config user.email github-actions@github.com && \
    git checkout -b dockerfile-run-example-regression-test && \
    git add . && \
    git commit -m "Run Example Regression Test" && \
    git push --set-upstream origin dockerfile-run-example-regression-test -f

### Run By:
### docker build \
###     --build-arg VALIDATION_MODE=1 \
###     --build-arg DOCS_REGRESSION_TEST_USER_ID=123456 \
###     --build-arg DOCS_REGRESSION_TEST_USER_TOKEN="user-token" \
###     --build-arg DOCS_REGRESSION_TEST_CS_PROJECT=12345678 \
###     --build-arg DOCS_REGRESSION_TEST_PY_PROJECT=87654321 \
###     -t example-regression-test-image .
### docker run example-regression-test-image